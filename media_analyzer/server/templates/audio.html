{% extends "base.html" %}
{% block title %}Audio Files - Media Analyzer{% endblock %}
{% block content %}
<h2 style="margin-bottom:16px;">Audio Files</h2>

<!-- Toolbar -->
<div class="toolbar">
    <input type="text" id="search" placeholder="Search filename..." style="flex:1; min-width:200px">
    <select id="filter-lossless">
        <option value="">All Formats</option>
        <option value="1">Lossless</option>
        <option value="0">Lossy</option>
    </select>
    <label style="display:flex; align-items:center; gap:4px; cursor:pointer; white-space:nowrap;">
        <input type="checkbox" id="group-artist"> Group by artist
    </label>
    <div class="col-toggle">
        <button class="btn-secondary" id="btn-columns" type="button">Columns</button>
        <div class="col-toggle-menu" id="col-menu"></div>
    </div>
</div>

<!-- Files table -->
<div class="card" style="padding:0;">
    <table id="files-table">
        <thead>
            <tr id="header-row"></tr>
        </thead>
        <tbody id="files-body"></tbody>
    </table>
</div>

<div class="pagination" id="pagination"></div>
{% endblock %}

{% block scripts %}
<script>
const COLUMNS = [
    { key: 'filename',    label: 'Filename',    sort: 'filename',  default: true },
    { key: 'artist',      label: 'Artist',      sort: null,        default: true },
    { key: 'album',       label: 'Album',       sort: null,        default: false },
    { key: 'title',       label: 'Title',       sort: null,        default: true },
    { key: 'sample_rate', label: 'Sample Rate', sort: null,        default: false },
    { key: 'channels',    label: 'Channels',    sort: null,        default: false },
    { key: 'lossless',    label: 'Lossless',    sort: null,        default: false },
    { key: 'duration',    label: 'Duration',    sort: 'duration',  default: true },
    { key: 'file_size',   label: 'Size',        sort: 'file_size', default: true },
];

const STORAGE_KEY = 'media-analyzer-audio-cols';
let visibleCols = loadColumnPrefs();

function loadColumnPrefs() {
    try {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) return JSON.parse(saved);
    } catch(e) {}
    return COLUMNS.filter(c => c.default).map(c => c.key);
}
function saveColumnPrefs() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(visibleCols));
}

const state = {
    page: 1, perPage: 50, sort: 'filename', order: 'asc',
    search: '', lossless: '', groupByArtist: false,
};

function formatDuration(sec) {
    if (!sec) return '-';
    const h = Math.floor(sec/3600), m = Math.floor((sec%3600)/60), s = Math.floor(sec%60);
    return h > 0 ? h+':'+String(m).padStart(2,'0')+':'+String(s).padStart(2,'0') : m+':'+String(s).padStart(2,'0');
}
function formatSize(b) { if (!b) return '-'; if (b>=1e9) return (b/1e9).toFixed(1)+' GB'; if (b>=1e6) return (b/1e6).toFixed(1)+' MB'; return (b/1e3).toFixed(0)+' KB'; }

function getVisibleColumns() { return COLUMNS.filter(c => visibleCols.includes(c.key)); }

function renderHeader() {
    const row = document.getElementById('header-row');
    row.replaceChildren();
    getVisibleColumns().forEach(col => {
        const th = document.createElement('th');
        th.textContent = col.label;
        if (col.sort) {
            th.dataset.sort = col.sort;
            if (state.sort === col.sort) th.classList.add('sorted');
            th.onclick = () => {
                if (state.sort === col.sort) { state.order = state.order === 'asc' ? 'desc' : 'asc'; }
                else { state.sort = col.sort; state.order = 'asc'; }
                document.querySelectorAll('th').forEach(h => h.classList.remove('sorted'));
                th.classList.add('sorted');
                state.page = 1;
                fetchFiles();
            };
        }
        row.appendChild(th);
    });
}

function buildColumnMenu() {
    const menu = document.getElementById('col-menu');
    menu.replaceChildren();
    COLUMNS.forEach(col => {
        const label = document.createElement('label');
        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.checked = visibleCols.includes(col.key);
        cb.onchange = () => {
            if (cb.checked) { visibleCols.push(col.key); }
            else { visibleCols = visibleCols.filter(k => k !== col.key); }
            saveColumnPrefs();
            renderHeader();
            fetchFiles();
        };
        label.appendChild(cb);
        label.appendChild(document.createTextNode(col.label));
        menu.appendChild(label);
    });
}

function cellValue(f, key) {
    switch(key) {
        case 'filename':    return { text: f.filename, title: f.file_path };
        case 'artist':      return { text: f.artist || '-' };
        case 'album':       return { text: f.album || '-' };
        case 'title':       return { text: f.audio_title || '-', title: f.audio_title || '' };
        case 'sample_rate': return { text: f.sample_rate ? (f.sample_rate / 1000) + ' kHz' : '-' };
        case 'channels':    return { text: f.channels != null ? f.channels + 'ch' : '-' };
        case 'lossless':    return { text: f.is_lossless ? 'Yes' : 'No' };
        case 'duration':    return { text: formatDuration(f.duration) };
        case 'file_size':   return { text: formatSize(f.file_size) };
        default:            return { text: '-' };
    }
}

async function fetchFiles() {
    const params = new URLSearchParams({
        page: state.page, per_page: state.perPage,
        sort: state.sort, order: state.order, media_type: 'audio',
    });
    if (state.search) params.set('search', state.search);
    if (state.lossless !== '') params.set('lossless', state.lossless);
    try {
        const res = await fetch('/api/files?' + params);
        const data = await res.json();
        renderFiles(data);
    } catch(e) { console.error('Failed to fetch files', e); }
}

function buildFileRow(f) {
    const tr = document.createElement('tr');
    tr.style.cursor = 'pointer';
    tr.onclick = () => toggleDetail(f.id, tr);
    const cols = getVisibleColumns();
    cols.forEach(col => {
        const val = cellValue(f, col.key);
        const td = document.createElement('td');
        td.textContent = val.text;
        td.title = val.title || val.text;
        tr.appendChild(td);
    });
    return tr;
}

function renderFiles(data) {
    const tbody = document.getElementById('files-body');
    tbody.replaceChildren();
    const colCount = getVisibleColumns().length;

    if (state.groupByArtist) {
        const groups = {};
        data.files.forEach(f => {
            const key = f.artist || 'Unknown';
            if (!groups[key]) groups[key] = [];
            groups[key].push(f);
        });
        const sortedKeys = Object.keys(groups).sort((a, b) => {
            if (a === 'Unknown') return 1;
            if (b === 'Unknown') return -1;
            return a.localeCompare(b);
        });
        sortedKeys.forEach(key => {
            const headerTr = document.createElement('tr');
            const headerTd = document.createElement('td');
            headerTd.colSpan = colCount;
            headerTd.style.cssText = 'background:#21262d; font-weight:bold; padding:8px 12px;';
            headerTd.textContent = key + ' (' + groups[key].length + ')';
            headerTr.appendChild(headerTd);
            tbody.appendChild(headerTr);
            groups[key].forEach(f => tbody.appendChild(buildFileRow(f)));
        });
        renderPagination(data);
        return;
    }

    data.files.forEach(f => tbody.appendChild(buildFileRow(f)));
    renderPagination(data);
}

async function toggleDetail(fileId, tr) {
    const nextRow = tr.nextElementSibling;
    if (nextRow && nextRow.classList.contains('detail-row')) { nextRow.classList.toggle('open'); return; }
    try {
        const res = await fetch('/api/files/' + fileId);
        const f = await res.json();
        const detailTr = document.createElement('tr');
        detailTr.className = 'detail-row open';
        const td = document.createElement('td');
        td.colSpan = getVisibleColumns().length;
        const content = document.createElement('div');
        content.className = 'detail-content';
        const dl = document.createElement('dl');
        dl.className = 'detail-grid';
        Object.entries(f).forEach(([k, v]) => {
            if (v == null || k === 'id' || k === 'file_id') return;
            const dt = document.createElement('dt'); dt.textContent = k;
            const dd = document.createElement('dd'); dd.textContent = String(v);
            dl.appendChild(dt); dl.appendChild(dd);
        });
        content.appendChild(dl); td.appendChild(content); detailTr.appendChild(td);
        tr.after(detailTr);
    } catch(e) { console.error('Detail fetch failed', e); }
}

function renderPagination(data) {
    const div = document.getElementById('pagination');
    div.replaceChildren();
    if (data.pages <= 1) return;
    for (let i = 1; i <= data.pages; i++) {
        if (data.pages > 10 && Math.abs(i - data.page) > 3 && i !== 1 && i !== data.pages) {
            if (Math.abs(i - data.page) === 4) { const s = document.createElement('span'); s.textContent = '...'; s.style.padding = '8px'; div.appendChild(s); }
            continue;
        }
        const btn = document.createElement('button');
        btn.textContent = i;
        if (i === data.page) btn.classList.add('active');
        btn.onclick = () => { state.page = i; fetchFiles(); };
        div.appendChild(btn);
    }
}

// Filters
let searchTimeout;
document.getElementById('search').addEventListener('input', e => {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => { state.search = e.target.value; state.page = 1; fetchFiles(); }, 300);
});
document.getElementById('filter-lossless').addEventListener('change', e => { state.lossless = e.target.value; state.page = 1; fetchFiles(); });
document.getElementById('group-artist').addEventListener('change', e => { state.groupByArtist = e.target.checked; fetchFiles(); });

// Column toggle
document.getElementById('btn-columns').onclick = () => document.getElementById('col-menu').classList.toggle('open');
document.addEventListener('click', e => {
    const toggle = document.querySelector('.col-toggle');
    if (!toggle.contains(e.target)) document.getElementById('col-menu').classList.remove('open');
});

document.getElementById('nav-audio').classList.add('active');
buildColumnMenu();
renderHeader();
fetchFiles();
</script>
{% endblock %}
